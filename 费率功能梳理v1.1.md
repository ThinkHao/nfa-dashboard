# [费率功能] 需求文档

## 目录
- [1. 需求背景](#1-需求背景)
- [2. 业务流程](#2-业务流程)
- [3. 数据定义](#3-数据定义)
- [4. 结算逻辑](#4-结算逻辑)
- [5. 用户及权限模块](#5-用户及权限模块)
- [6. 操作日志](#6-操作日志)
- [7. API 接口设计 (V1)](#7-api-接口设计-v1)
- [8. 非功能性需求](#8-非功能性需求)

## 1. 需求背景

每月结账时，需要手工计算以及特殊情况需要人工特殊处理，需要一个工具支持一键导出账单。

- 结算功能：支持录入各种费用，便于结算
- 进制功能：用于网络流量进行单位换算，对象化管理不同的进制，如1000 * 1000 * 1024和 1000 * 1000 * 1000此类不同的换算方式，方便进修改和结算时调用。有专门的前端入口进行配置和管理。

## 2. 业务流程

- 用户在前端页面录入费率信息，写入到业务费率表中，对于 edc 和 nfa 两种类型的费率分别写入节点业务费率表和客户业务费率表中；
- 两张业务费率表中录入的内容，会由程序刷写到最终客户费率表中，由于 edc 费率信息中没有 school_name 字段，在刷写 edc 费率到最终客户费率表中时，约定 school_name 填写一个特殊字符如“not_a_school”来进行区分；
- 用户也可以单独指定某个 region + cp + school_name 的费率，写入最终客户费率表中；
- 所有院校的费率都会汇总到最终客户费率表中，此表中有字段表明是手工配置，还是通过业务费率表继承过来的，“auto”表示通过业务费率表刷写过来，“config”表示手工配置；
- 表3由表1生成，表2独立；
- 结算金额的计算，将依据【4. 结算逻辑】中的公式，结合【表1】和【表2】中的费率进行。



## 3. 数据定义

### 表 1：客户业务费率表（数据来源nfa）

|       字段       | 类型 | 约束 |                             说明                             |
| :--------------: | :--: | :--: | :----------------------------------------------------------: |
|      region      |      |      |                             省份                             |
|        cp        |      |      |                            内容方                            |
|   school_name    |      |      |                           学校名称                           |
|   customer_fee   |      |      |                       客户费率（支出）                       |
| network_line_fee |      |      |                       线路费率（支出）                       |
|   general_fee    |      |      | 单区域单业务的默认费率，没有设置具体院校的时候，费率归属此字段；此字段变更，需要触发更新 |
| customer_fee_owner_id | int | 外键 | 客户费用归属对象ID，关联【表7】 | 
| network_line_fee_owner_id | int | 外键 | 线路费用归属对象ID，关联【表7】 |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

> **表示例**
> 
> | region | cp | school_name | customer_fee | network_line_fee | general_fee | customer_fee_owner_id | network_line_fee_owner_id |
> | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
> | 北京 | B站 | 北京石油大学 | 50 | 20 | 60 | 1 | 2 |

**索引设计**：
- 建议为 `region`、`cp`、`school_name` 字段创建索引，以提升查询性能
- 其他索引根据后续开发过程中的实际查询需求进行补充

### 表 2：节点业务费率表（数据来源 edc）

|         字段          | 类型 | 约束 |           说明           |
| :-------------------: | :--: | :--: | :----------------------: |
|        region         |      |      |           省份           |
|          cp           |      |      |          内容方          |
|        cp_fee         |      |      |    内容方费率（收入）    |
|   cp_fee_owner_id     | int  | 外键 | 内容方费用归属对象ID，关联【表7】 |
| node_construction_fee |      |      |   节点建设费率（支出）   |
| node_construction_fee_owner_id | int  | 外键 | 节点建设费用归属对象ID，关联【表7】 |
|       rack_fee        |      |      |      机柜费（支出）      |
|   rack_fee_owner_id   | int  | 外键 | 机柜费用归属对象ID，关联【表7】 |
|       other_fee       |      |      |   其他固定费用（支出）   |
|   other_fee_owner_id  | int  | 外键 | 其他费用归属对象ID，关联【表7】 |
|    settlement_type    |      |      | 结算类型（日95还是月95） |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

> **表示例**
> 
> | region | cp | cp_fee | cp_fee_owner_id | node_construction_fee | node_construction_fee_owner_id | rack_fee | rack_fee_owner_id | other_fee | other_fee_owner_id | settlement_type |
> | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
{{ ... }}
> | 北京 | B站 | 80 | 3 | 15 | 3 | 5000 | 3 | 1000 | 3 | daily95 |

**索引设计**：
- 建议为 `region`、`cp` 字段创建索引，以提升查询性能
- 其他索引根据后续开发过程中的实际查询需求进行补充

### 表 3：最终客户费率表

> **设计说明**：此表的核心作用是提供一个**手动干预**的机制。系统默认根据【表1】自动计算费率（此时`fee_type`为'auto'）。当需要为特定业务设置一个不符合标准规则的“一口价”或特殊价格时，可在此表中手动配置一条记录（此时`fee_type`为'config'），系统结算时将优先采用这里配置的`final_fee`，从而实现对标准费率的灵活覆盖。

|     字段     | 类型 |    约束     |       说明       |
| :----------: | :--: | :---------: | :--------------: |
|    region    |      |             |       省份       |
|      cp      |      |             |      内容方      |
| school_name  |      |             |     学校名称     |
|  final_fee   |      |             |   最终客户费率   |
|   fee_type   |      | auto/config |     费率类型（auto: 自动计算, config: 手动配置）     |
| customer_fee |      |             | 客户费率（支出） |
| customer_fee_owner_id | int | 外键 | 客户费用归属对象ID，关联【表7】 |
| network_line_fee |      |             | 线路费率（支出） |
| network_line_fee_owner_id | int | 外键 | 线路费用归属对象ID，关联【表7】 |
| node_deduction_fee |      |             | 节点建设倒扣费率（支出） |
| node_deduction_fee_owner_id | int | 外键 | 节点倒扣费用归属对象ID，关联【表7】 |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

> **表示例**
> 
> | region | cp | school_name | final_fee | fee_type | customer_fee | customer_fee_owner_id |
> | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
> | 北京 | B站 | 北京石油大学 | 50 | auto | 50 | 1 |

**索引设计**：
- 建议为 `region`、`cp`、`school_name` 字段创建索引，以提升查询性能
- 其他索引根据后续开发过程中的实际查询需求进行补充

### 表 4：客户结算金额表

|       字段        | 类型 | 约束 |    说明    |
| :---------------: | :--: | :--: | :--------: |
|      region       |      |      |    省份    |
|        cp         |      |      |   内容方   |
|    school_name    |      |      |  学校名称  |
| settlement_value  |      |      |   日95值   |
|  settlement_time  |      |      | 95结算时间 |
|   customer_fee    |      |      |  客户费率  |
|   customer_bill   |      |      |  客户金额  |
| customer_fee_owner_id | int | 外键 | 客户费用归属对象ID，关联【表7】 |
| network_line_fee  |      |      |  线路费率  |
| network_line_bill |      |      |  线路金额  |
| network_line_fee_owner_id | int | 外键 | 线路费用归属对象ID，关联【表7】 |
| node_deduction_fee |      |      | 节点建设倒扣费率 |
| node_deduction_bill |      |      | 节点建设倒扣金额 |
| node_deduction_fee_owner_id | int | 外键 | 节点倒扣费用归属对象ID，关联【表7】 |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

> **表示例**
> 
> | region | cp | school_name | settlement_value | customer_bill | customer_fee_owner_id | network_line_bill | network_line_fee_owner_id | ... |
> | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
> | 北京 | B站 | 北京石油大学 | 1000Mbps | 50000 | 1 | 20000 | 2 | ... |

**索引设计**：
- 建议为 `region`、`cp`、`school_name` 字段创建索引，以提升查询性能
- 其他索引根据后续开发过程中的实际查询需求进行补充

### 表5：节点日95结算金额表

| 字段                   | 类型 | 约束 | 说明                 |
| ---------------------- | ---- | ---- | -------------------- |
| region                 |      |      | 省份                 |
| cp                     |      |      | 内容方               |
| cp_fee                 |      |      | 内容方费率（收入）   |
| cp_bill                |      |      | 内容方金额           |
| cp_fee_owner_id | int | 外键 | 内容方费用归属对象ID，关联【表7】 |
| node_construction_fee  |      |      | 节点建设费率（支出） |
| node_construction_bill |      |      | 节点建设金额         |
| node_construction_fee_owner_id | int | 外键 | 节点建设费用归属对象ID，关联【表7】 |
| rack_fee               |      |      | 机柜费率（支出）     |
| rack_bill              |      |      | 机柜费               |
| rack_fee_owner_id | int | 外键 | 机柜费用归属对象ID，关联【表7】 |
| other_fee              |      |      | 其他固定费率（支出） |
| other_bill             |      |      | 其他固定费用         |
| other_fee_owner_id | int | 外键 | 其他费用归属对象ID，关联【表7】 |
| settlement_value       |      |      | 日95值               |
| settlement_time        |      |      | 95结算时间           |
| daily95_fee            |      |      | 日95结算单价         |
| daily95_bill           |      |      | 日95结算金额         |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

**索引设计**：
- 建议为 `region`、`cp` 字段创建索引，以提升查询性能
- 其他索引根据后续开发过程中的实际查询需求进行补充

### 表6：节点月95结算金额表

| 字段                   | 类型 | 约束 | 说明                 |
| ---------------------- | ---- | ---- | -------------------- |
| region                 |      |      | 省份                 |
| cp                     |      |      | 内容方               |
| cp_fee                 |      |      | 内容方费率（收入）   |
| cp_bill                |      |      | 内容方金额           |
| cp_fee_owner_id | int | 外键 | 内容方费用归属对象ID，关联【表7】 |
| node_construction_fee  |      |      | 节点建设费率（支出） |
| node_construction_bill |      |      | 节点建设金额         |
| node_construction_fee_owner_id | int | 外键 | 节点建设费用归属对象ID，关联【表7】 |
| rack_fee               |      |      | 机柜费率（支出）     |
| rack_bill              |      |      | 机柜费               |
| rack_fee_owner_id | int | 外键 | 机柜费用归属对象ID，关联【表7】 |
| other_fee              |      |      | 其他固定费率（支出） |
| other_bill             |      |      | 其他固定费用         |
| other_fee_owner_id | int | 外键 | 其他费用归属对象ID，关联【表7】 |
| settlement_value       |      |      | 月95值               |
| settlement_time        |      |      | 95结算时间           |
| monthly95_fee          |      |      | 月95结算单价         |
| monthly95_bill         |      |      | 月95结算金额         |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

**索引设计**：
- 建议为 `region`、`cp` 字段创建索引，以提升查询性能
- 其他索引根据后续开发过程中的实际查询需求进行补充

## 4. 结算逻辑

### 一、成本单元

#### 1. 下游客户结算逻辑+内部销售提成

a. 区域+院校+业务，构成一个下游结算的最小基础单元

b. 该结算单元对于公司来说是成本，主要的成本包含下面三类费用，目前约定的是与带宽挂钩，也就是设置的是单价，最终需要根据带宽结算值折算为金额。
    i. 客户费用 = 客户费率 * 客户结算数值
    ii. 线路供应商费用 = 线路成本费率 * 客户结算数值
    iii. 节点建设倒扣费用（类似石油大学的舒华士侧成本倒扣）= 节点建设倒扣费用 * 客户结算数值 (按照正数值来统计，纳入节点建设成本支出时，则应该予以扣除)

c. 该结算单元目前不存在其他对外成本

d. 内部销售提成方案
    i. 涉及到区域+院校+业务单元里的单价设置，以及方案选择（当前是固定的，第一年100%，第二年75%，第三年20%）

**结算费用归属**，通过在费率表和结算表中为各类费用（如客户费、线路费等）指定其归属的业务对象ID（`owner_id`），实现费用的精确归属。业务对象可以是客户、线路供应商、节点或销售人员等，统一在【表7：业务对象表】中进行管理，方便后续进行多维度的费用展示与计算。

**费用归属示例**

| | 北京石油B站 | 中国政法B站 | 北京农学院 | 天津大学城金山（跨省） |
| :--- | :--- | :--- | :--- | :--- |
| **客户费用** | 蒋总 | 舒华士 | 舒华士 | 天津长宽 |
| **线路供应商费用** | 信息网 | 信息网 | | |
| **节点建设倒扣费用** | 舒华士（节点方） | | 舒华士（节点方） | 舒华士（节点方） |
| **内部销售提成** | 刘旭阳 | | | |

#### 3. 详细结算场景示例

为了更清晰地展示整个流程，我们以`北京`的`B站`业务在`北京石油大学`的结算为例，一步步说明如何计算各项费用。

**场景**: 结算周期结束时，系统测得`北京石油大学`的`B站`业务的带宽用量为 **1000 Mbps**。

**第一步：查找相关费率和归属**

程序首先查询【表1：客户业务费率表】，找到与该业务匹配的记录：
- `customer_fee`: 50
- `network_line_fee`: 20
- `customer_fee_owner_id`: 1
- `network_line_fee_owner_id`: 2

**第二步：确定费用归属方**

程序使用`owner_id`去查询【表7：业务对象表】，确定费用的具体归属方：
- `customer_fee_owner_id` (1) -> `entity_name`: **蒋总**
- `network_line_fee_owner_id` (2) -> `entity_name`: **信息网**

**第三步：计算结算金额**

根据结算公式，计算各项费用金额：
- **客户费用**: `customer_fee` * `settlement_value` = 50 * 1000 = **50,000**
- **线路供应商费用**: `network_line_fee` * `settlement_value` = 20 * 1000 = **20,000**

**第四步：生成结算记录**

最后，程序将计算结果写入【表4：客户结算金额表】，生成一条清晰的结算记录：

| region | cp | school_name | settlement_value | customer_bill | customer_fee_owner_id | network_line_bill | network_line_fee_owner_id |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 北京 | B站 | 北京石油大学 | 1000Mbps | 50000 | 1 (蒋总) | 20000 | 2 (信息网) |

#### 2. 下游节点结算逻辑

a. 区域+业务，构成一个下游节点结算的最小基础单元

b. 该结算单元对于公司来说是成本，主要的成本包含：节点建设费用支出、机柜成本支出（不一定等于给上游的机柜费）、其他支出
    i. 节点建设费用支出 = 节点建设费率 * 我司统计数值
    ii. 机柜成本支出为固定数值
    iii. 其他支出为固定数值（目前主要为固定的传输线路等费用）

> #### 下游节点结算场景示例
> 
> 我们以`北京`的`B站`这个下游节点的日结算为例，说明其收支计算过程。
> 
> **场景**: 结算日，系统测得`北京B站`节点的 **日95带宽用量** 为 **800 Mbps**。
> 
> **第一步：查找节点费率和归属**
> 
> 程序查询【表2：节点业务费率表】，找到与该节点匹配的记录：
> - `cp_fee`: 80 (收入)
> - `node_construction_fee`: 15 (支出)
> - `rack_fee`: 5000 (固定支出)
> - `other_fee`: 1000 (固定支出)
> - 所有费用的 `owner_id` 均为: 3
> 
> **第二步：确定费用归属方**
> 
> 程序使用 `owner_id` (3) 去查询【表7：业务对象表】，确定所有收支均归属于 -> `entity_name`: **舒华士（节点方）**
> 
> **第三步：计算结算金额**
> 
> 根据结算公式，计算各项收支金额：
> - **内容方收入**: `cp_fee` * `daily_95_value` = 80 * 800 = **64,000**
> - **节点建设支出**: `node_construction_fee` * `daily_95_value` = 15 * 800 = **12,000**
> - **机柜费支出**: `rack_fee` = **5,000** (固定值)
> - **其他固定支出**: `other_fee` = **1,000** (固定值)
> 
> **第四步：生成节点结算记录**
> 
> 最后，程序将计算结果写入【表5：节点日95结算金额表】，生成一条清晰的节点结算记录：
> 
> | region | cp | daily_95_value | cp_bill | node_construction_bill | rack_bill | other_bill | cp_fee_owner_id |
> | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
> | 北京 | B站 | 800Mbps | 64000 | 12000 | 5000 | 1000 | 3 (舒华士) |

### 二、收入单元

#### 3. 上游节点结算逻辑（暂不实现）

a. 区域+业务，构成一个上游节点结算的最小基础单元

b. 该结算单元对于公司来说是收入，主要的收入包含内容方带宽收入、机柜收入、其他收入（IP收入）
    i. 内容方带宽收入 = 内容方费率 * 结算数值
    ii. 机柜收入为固定数值
    iii. IP收入为固定数值

## 5. 用户及权限模块

### 5.1. 功能概述
为支持费率系统的精细化管理和安全访问，需要引入用户及权限模块。该模块负责管理系统用户、角色及其对不同功能模块的访问权限。

-   **用户登录**：提供安全的登录认证机制。
-   **用户管理**：支持系统管理员对用户信息（增、删、改、查）的管理。
-   **角色管理**：系统预设或支持管理员自定义角色，如“管理员”、“销售”、“财务”、“业务录入员”等。
-   **权限管理**：将系统功能点抽象为权限，实现角色与权限的灵活绑定，从而控制不同角色的用户可以访问和操作的功能范围。

### 5.2. 核心功能
-   **登录/登出**：用户通过用户名和密码登录系统，系统生成会话或Token。支持安全退出。
-   **密码修改**：用户登录后可以修改自己的密码。
-   **用户列表**：管理员可以查看所有用户的信息，并进行搜索、添加、编辑和删除用户操作。
-   **角色列表**：管理员可以管理角色信息，包括创建新角色、修改角色名称和描述、删除角色。
-   **权限分配**：管理员可以为每个角色分配具体的功能权限，如“费率录入”、“账单查看”、“用户管理”等。

### 5.3. 数据定义
为支持用户及权限模块，新增以下数据表：

#### 表7：业务对象表 (business_entities)

为统一管理费用归属的各类主体，定义业务对象表。此表中的记录可以是客户、线路供应商、节点、销售人员等。

| 字段 | 类型 | 约束 | 说明 |
| :--- | :-- | :-- | :--- |
| entity_id | int | 主键, 自增 | 对象唯一标识 |
| entity_type | varchar(50) | 非空 | 对象类型 (customer, line_provider, node, sales) |
| entity_name | varchar(100) | 唯一, 非空 | 对象名称（如：蒋总, 舒华士, 信息网, 刘旭阳） |
| contact_info | varchar(255) | | 联系方式（可选） |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

> **表示例**
> 
> | entity_id | entity_type | entity_name | contact_info |
> | :--- | :--- | :--- | :--- |
> | 1 | customer | 蒋总 | 138******** |
> | 2 | line_provider | 信息网 | 139******** |
> | 3 | node | 舒华士（节点方）| 137******** |
> | 4 | sales | 刘旭阳 | 136******** |



#### 表8：用户表 (users)
| 字段 | 类型 | 约束 | 说明 |
| :--- | :-- | :-- | :--- |
| user_id | int | 主键, 自增 | 用户唯一标识 |
| username | varchar(50) | 唯一, 非空 | 用户名，用于登录 |
| password_hash | varchar(255) | 非空 | 加密后的用户密码 |
| email | varchar(100) | 唯一 | 用户邮箱 |
| alias | varchar(50) | | 用户别名 |
| role_id | int | 外键 | 关联到角色表 |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

#### 表9：角色表 (roles)
| 字段 | 类型 | 约束 | 说明 |
| :--- | :-- | :-- | :--- |
| role_id | int | 主键, 自增 | 角色唯一标识 |
| role_name | varchar(50) | 唯一, 非空 | 角色名称（如：管理员, 销售） |
| description | varchar(255) | | 角色描述 |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

#### 表10：权限表 (permissions)
| 字段 | 类型 | 约束 | 说明 |
| :--- | :-- | :-- | :--- |
| permission_id | int | 主键, 自增 | 权限唯一标识 |
| permission_name | varchar(50) | 唯一, 非空 | 权限名称（如：view_bill, edit_rate） |
| description | varchar(255) | | 权限描述 |
| module | varchar(50) | | 所属模块（如：费率, 结算, 用户） |
| created_at | datetime | | 创建时间 |
| updated_at | datetime | | 更新时间 |

#### 表11：角色-权限关联表 (role_permissions)
| 字段 | 类型 | 约束 | 说明 |
| :--- | :-- | :-- | :--- |
| role_id | int | 主键, 外键 | 角色ID |
| permission_id | int | 主键, 外键 | 权限ID |
| created_at | datetime | | 创建时间 |

### 5.4. 默认角色与权限

根据业务需求，初步设置以下角色及其权限：

| 角色 | 权限范围 |
| :--- | :--- |
| **管理员 (Admin)** | 拥有系统所有权限，包括用户管理、角色权限配置、费率管理、结算查看等。 |
| **销售 (Sales)** | 负责客户和费率的初步录入。权限：查看/编辑自己负责的客户业务费率，但不能修改最终费率；查看与自己相关的结算报表。 |
| **财务 (Finance)** | 负责账单的核对与导出。权限：查看所有结算报表、导出账单，对费率信息有只读权限。 |
| **业务录入员 (Operator)** | 负责日常的费率数据录入和维护。权限：增/删/改【客户业务费率表】和【节点业务费率表】。 |

> **注意**：以上为默认配置，具体权限可在【角色-权限关联表】中进行灵活配置。

## 6. 操作日志

为保证系统的安全性和可追溯性，增加操作日志功能，记录所有用户的关键操作。

### 6.1. 功能说明
- **日志记录**：系统自动记录用户对费率、结算、用户信息等关键数据的增、删、改操作。
- **日志查询**：管理员可以根据操作人、时间范围、操作类型等条件查询操作日志。

### 6.2. 数据定义

#### 表12：操作日志表 (audit_logs)
| 字段 | 类型 | 约束 | 说明 |
| :--- | :-- | :-- | :--- |
| log_id | int | 主键, 自增 | 日志唯一标识 |
| user_id | int | 外键 | 操作用户的ID |
| username | varchar(50) | | 操作用户的名称（冗余，方便查询） |
| action | varchar(255) | | 操作描述（如：'创建用户: zhangsan'） |
| target_table | varchar(50) | | 被操作的表名 |
| target_id | int | | 被操作记录的ID |
| before_change | text | | 操作前的数据（可选，JSON格式） |
| after_change | text | | 操作后的数据（可选，JSON格式） |
| created_at | datetime | | 操作时间 |

## 7. API 接口设计 (V1)

为了实现上述功能，后端需要提供一系列API接口。以下是初步的接口设计。

### 7.1. 认证接口

| 功能 | 方法 | 路径 | 说明 |
| :--- | :--- | :--- | :--- |
| 用户登录 | POST | `/api/auth/login` | 提交 `username` 和 `password`，成功后返回 `token` |
| 用户登出 | POST | `/api/auth/logout` | 清除服务端会话或使 `token` 失效 |
| 获取当前用户信息 | GET | `/api/auth/me` | 根据请求头中的 `token` 获取当前登录用户的信息 |

### 7.2. 用户管理接口

*需要管理员权限*

| 功能 | 方法 | 路径 | 说明 |
| :--- | :--- | :--- | :--- |
| 获取用户列表 | GET | `/api/users` | 支持分页和按 `username` 搜索 |
| 创建新用户 | POST | `/api/users` | 请求体包含 `username`, `password`, `email`, `role_id` |
| 获取指定用户信息 | GET | `/api/users/{userId}` | 获取单个用户的详细信息 |
| 更新用户信息 | PUT | `/api/users/{userId}` | 更新用户信息，如 `email`, `role_id` 等 |
| 删除用户 | DELETE | `/api/users/{userId}` | 删除指定用户 |

### 7.3. 角色与权限管理接口

*需要管理员权限*

| 功能 | 方法 | 路径 | 说明 |
| :--- | :--- | :--- | :--- |
| 获取角色列表 | GET | `/api/roles` | 返回所有角色信息 |
| 创建新角色 | POST | `/api/roles` | 请求体包含 `role_name`, `description` |
| 更新角色信息 | PUT | `/api/roles/{roleId}` | 更新角色名称或描述 |
| 删除角色 | DELETE | `/api/roles/{roleId}` | 删除角色（需处理好关联用户的逻辑） |
| 获取所有权限 | GET | `/api/permissions` | 返回系统中定义的所有权限点 |
| 获取角色的权限 | GET | `/api/roles/{roleId}/permissions` | 查看指定角色拥有的权限 |
| 为角色分配权限 | PUT | `/api/roles/{roleId}/permissions` | 请求体为权限ID列表，更新角色所拥有的权限 |

### 7.4. 费率管理接口

| 功能 | 方法 | 路径 | 说明 |
| :--- | :--- | :--- | :--- |
| 获取客户业务费率 | GET | `/api/rates/customer` | 查询【表1】，支持按 `region`, `cp`, `school_name` 筛选 |
| 新增/更新客户业务费率 | POST | `/api/rates/customer` | 录入或修改客户业务费率，请求体需包含 `customer_fee_owner_id`, `network_line_fee_owner_id` 等 |

> **请求体示例**
> ```json
> {
>   "region": "北京",
>   "cp": "B站",
>   "school_name": "北京石油大学",
>   "customer_fee": 50,
>   "network_line_fee": 20,
>   "customer_fee_owner_id": 1,
>   "network_line_fee_owner_id": 2
> }
> ```
| 获取节点业务费率 | GET | `/api/rates/node` | 查询【表2】，支持按 `region`, `cp` 筛选 |
| 新增/更新节点业务费率 | POST | `/api/rates/node` | 录入或修改节点业务费率，请求体需包含各项费用的 `owner_id` |
| 获取最终客户费率 | GET | `/api/rates/final` | 查询【表3】，支持按 `region`, `cp`, `school_name` 筛选 |
| 手工配置最终客户费率 | POST | `/api/rates/final` | 手工指定 `region` + `cp` + `school_name` 的最终费率 |

### 7.5. 业务对象管理接口

| 功能 | 方法 | 路径 | 说明 |
| :--- | :--- | :--- | :--- |
| 获取业务对象列表 | GET | `/api/entities` | 查询【表7】，支持按 `entity_type`, `entity_name` 筛选 |
| 创建新业务对象 | POST | `/api/entities` | 请求体包含 `entity_type`, `entity_name` 等信息 |

> **请求体示例**
> ```json
> {
>   "entity_type": "customer",
>   "entity_name": "蒋总",
>   "contact_info": "138********"
> }
> ```
| 获取指定业务对象 | GET | `/api/entities/{entityId}` | 获取单个业务对象的详细信息 |
| 更新业务对象信息 | PUT | `/api/entities/{entityId}` | 更新业务对象信息 |
| 删除业务对象 | DELETE | `/api/entities/{entityId}` | 删除指定业务对象 |

### 7.6. 结算管理接口

| 功能 | 方法 | 路径 | 说明 |
| :--- | :--- | :--- | :--- |
| 获取客户结算数据 | GET | `/api/settlements/customer` | 查询【表4】，支持按 `region`, `cp`, `school_name` 及时间范围筛选 |
| 获取节点结算数据 | GET | `/api/settlements/node` | 查询【表5】和【表6】，支持按 `region`, `cp` 及时间范围筛选 |
| 触发结算计算 | POST | `/api/settlements/run` | 手动触发一个结算周期的计算任务 |
| 导出结算报表 | GET | `/api/settlements/export` | 根据查询条件导出指定类型的结算报表（如Excel） |

## 8. 非功能性需求

### 8.1. 性能需求
- **API 响应时间**：常规的 CRUD (增删改查) API 接口，95% 的请求应在 200ms 内响应。
- **报表生成**：月度结算报表的生成和导出时间应在 30 秒内完成。
- **并发用户**：系统应支持至少 50 个并发用户同时在线操作而无明显性能下降。

### 8.2. 安全性需求
- **认证与授权**：所有 API 接口都必须经过认证和授权检查，防止未经授权的访问。
- **密码存储**：用户密码必须使用业界推荐的哈希算法（如 bcrypt 或 Argon2）加盐后存储，绝不能明文存储。
- **数据传输**：系统应全站使用 HTTPS，保证数据在传输过程中的加密。
- **防范常见漏洞**：应采取措施防范 SQL 注入、跨站脚本（XSS）、跨站请求伪造（CSRF）等常见 Web 攻击。

### 8.3. 可扩展性需求
- **无状态服务**：后端应用应设计为无状态服务，便于水平扩展和负载均衡。
- **模块化设计**：系统应采用模块化设计，各模块之间低耦合，便于未来独立升级或扩展新功能。

### 8.4. 可用性需求
- **系统可用性**：核心功能（如费率录入、结算查询）的可用性目标应达到 99.9%。
- **数据备份**：应建立定期的数据库备份机制，并有相应的恢复计划，以防数据丢失。
