# 结算系统开发计划

## 背景

需要添加结算系统，当前的任务是先准备好结算用的底层数据，要求后端能够周期性地计算每所院校的日95值，并存入数据库。结算规则参考日95结算方法：将每天的流速按照从大到小进行排序，去掉前5%的数据，取剩余数据的最大值作为当天的结算值。

## 数据库设计

已创建以下数据库表：

1. **nfa_school_settlement** - 存储院校日95结算数据
   - 包含省份、CP、院校名称、日95结算值、结算时间等字段
   - 支持日结算和周结算两种类型

2. **nfa_settlement_config** - 存储结算配置信息
   - 配置每日结算时间（默认凌晨2点）
   - 配置每周结算时间（默认周一凌晨2点）
   - 记录上次执行时间和启用状态

3. **nfa_settlement_task** - 记录结算任务执行情况
   - 记录任务类型、执行状态、开始/结束时间
   - 记录处理记录数和错误信息（如有）

## 后端开发计划

1. **模型层开发**
   - 创建 `SchoolSettlement` 模型，对应 `nfa_school_settlement` 表
   - 创建 `SettlementConfig` 模型，对应 `nfa_settlement_config` 表
   - 创建 `SettlementTask` 模型，对应 `nfa_settlement_task` 表
   - 创建相关的请求/响应结构体

2. **仓储层开发**
   - 实现结算数据的CRUD操作
   - 实现结算配置的CRUD操作
   - 实现结算任务的CRUD操作

3. **服务层开发**
   - 实现日95计算逻辑（按照从大到小排序，去掉前5%，取最大值）
   - 实现定时任务调度器，支持每日和每周定时执行结算任务
   - 实现结算任务执行和状态管理

4. **控制器层开发**
   - 实现结算配置管理API
   - 实现结算任务管理API
   - 实现结算数据查询API

5. **定时任务实现**
   - 实现每日凌晨2点计算前一天所有院校的日95值
   - 实现每周一凌晨2点计算上一周所有院校每天的日95值
   - 实现任务状态监控和错误处理机制

## 前端开发计划

1. **结算管理模块**
   - 创建独立的结算管理菜单，与现有功能分开
   - 实现结算配置页面，支持配置结算时间
   - 实现结算任务状态页面，展示当前和历史任务状态

2. **结算配置页面**
   - 展示当前结算配置（每日结算时间、每周结算日期和时间）
   - 提供配置修改功能
   - 提供结算任务启用/禁用功能

3. **结算任务状态页面**
   - 展示当前正在执行的结算任务状态
   - 提供历史结算任务查询功能
   - 展示任务执行详情（开始时间、结束时间、处理记录数、状态等）

4. **结算数据查询页面**
   - 提供按日期、省份、CP、院校等条件查询结算数据
   - 支持日结算和周结算数据的切换查看
   - 提供数据导出功能

## 测试计划

1. **单元测试**
   - 测试日95计算逻辑的正确性
   - 测试定时任务调度的准确性

2. **集成测试**
   - 测试结算数据的完整流程
   - 测试配置修改对结算任务的影响

3. **UI测试**
   - 测试前端页面的功能和交互

## 部署计划

1. **数据库迁移**
   - 执行SQL脚本创建新表
   - 初始化结算配置数据

2. **后端部署**
   - 部署新版本后端服务
   - 启动定时任务调度器

3. **前端部署**
   - 部署新版本前端应用

## 时间规划

1. 数据库设计与创建：1天
2. 后端模型层和仓储层开发：2天
3. 后端服务层和定时任务开发：3天
4. 后端控制器层和API开发：2天
5. 前端结算管理模块开发：3天
6. 测试与修复：2天
7. 部署与上线：1天

总计：约14天工作量

## 风险评估

1. 数据量大可能导致结算计算耗时较长，需要考虑性能优化
2. 定时任务需要保证高可靠性，避免任务丢失或重复执行
3. 结算数据的准确性至关重要，需要多重验证机制

## 后续计划

1. 实现结算数据的可视化展示
2. 添加结算数据异常检测机制
3. 实现结算数据与计费系统的对接
