# 院校流速图展示系统开发计划

## 数据表分析

1. **nfa_school表**：包含院校基本信息，如学校ID、名称、地区、运营商等。
2. **nfa_school_traffic表**：包含院校流量数据，记录了接收和发送流量，并有时间戳。

根据查询性能考虑，我建议主要使用`nfa_school_traffic`表进行流量数据查询，并与`nfa_school`表进行关联以获取更多院校信息。`nfa_school_traffic`表已经建立了多个索引，特别是`idx_time_region_school_cp`复合索引，非常适合按照时间、地区、学校名称和运营商进行过滤查询。

## 开发计划

### 1. 技术栈选择

#### 后端
- **语言**：Go（因其高性能特性更适合处理大量数据查询）
- **框架**：Gin（轻量级、高性能的Web框架）
- **数据库访问**：GORM（Go的ORM库，简化数据库操作）
- **缓存**：Redis（用于缓存频繁查询的数据，提高响应速度）

#### 前端
- **框架**：Vue.js + Element UI（适合构建数据可视化界面）
- **图表库**：ECharts（功能强大，支持多种图表类型，适合流量数据可视化）
- **HTTP客户端**：Axios（用于与后端API通信）

### 2. 系统架构

```
客户端 <--> Nginx <--> Go后端服务 <--> MySQL数据库
                           ^
                           |
                          Redis缓存
```

### 3. 后端开发计划

1. **项目初始化**
   - 设置Go模块和项目结构
   - 配置Gin框架和GORM
   - 设置环境配置和日志系统

2. **数据模型定义**
   - 定义与数据库表对应的结构体
   - 设置ORM映射关系

3. **API设计与实现**
   - `/api/v1/schools` - 获取学校列表（支持分页和过滤）
   - `/api/v1/regions` - 获取所有地区列表
   - `/api/v1/cps` - 获取所有运营商列表
   - `/api/v1/traffic` - 获取流量数据（支持时间范围、学校、地区、运营商过滤）
   - `/api/v1/traffic/summary` - 获取流量汇总数据

4. **查询优化**
   - 实现数据聚合和预计算
   - 设计缓存策略，缓存常用查询结果
   - 针对大数据量查询进行分页和限制

5. **中间件实现**
   - CORS支持
   - 请求日志记录
   - 错误处理
   - 性能监控

### 4. 前端开发计划

1. **项目初始化**
   - 设置Vue项目
   - 配置Element UI和ECharts
   - 设置路由和状态管理

2. **页面组件开发**
   - 导航栏和布局组件
   - 过滤器组件（地区、学校、运营商、时间范围选择器）
   - 流量图表组件（支持多种视图：折线图、柱状图等）
   - 数据表格组件（展示详细数据）

3. **数据可视化实现**
   - 实现流量趋势图（按时间展示流量变化）
   - 实现流量分布图（按地区、学校、运营商分组）
   - 实现实时流量监控（可选）

4. **交互功能**
   - 实现图表交互（缩放、点击、悬停提示等）
   - 实现数据导出功能
   - 实现图表配置保存功能

### 5. 部署计划

1. **后端部署**
   - 编译Go应用为二进制文件
   - 配置Systemd服务
   - 设置Nginx反向代理

2. **前端部署**
   - 构建Vue应用
   - 部署静态文件到Nginx

3. **数据库优化**
   - 检查并优化索引
   - 配置数据库连接池
   - 设置数据库备份策略

### 6. 性能优化计划

1. **查询优化**
   - 使用适当的索引
   - 实现查询结果缓存
   - 考虑使用读写分离（如果数据量非常大）

2. **前端优化**
   - 实现组件懒加载
   - 优化大数据量渲染性能
   - 实现数据分页加载

3. **监控与告警**
   - 实现系统性能监控
   - 设置关键指标告警

## 项目时间线

1. **准备阶段**（1周）
   - 需求分析和技术选型
   - 环境搭建和项目初始化

2. **后端开发**（2周）
   - 数据模型和API实现
   - 查询优化和缓存策略

3. **前端开发**（2周）
   - 界面设计和组件开发
   - 数据可视化实现

4. **集成测试**（1周）
   - 前后端集成
   - 性能测试和优化

5. **部署上线**（1周）
   - 系统部署
   - 监控配置和文档编写

# 结算系统开发计划

## 背景

需要添加结算系统，当前的任务是先准备好结算用的底层数据，要求后端能够周期性地计算每所院校的日95值，并存入数据库。结算规则参考日95结算方法：将每天的流速按照从大到小进行排序，去掉前5%的数据，取剩余数据的最大值作为当天的结算值。

注意：每天计算前一天的数据以及每周计算前一周的数据，只是一种冗余手段，防止缺失部分结算信息。结算类型只有一种，就是日95结算。

## 数据库设计

已创建以下数据库表：

1. **nfa_school_settlement** - 存储院校日95结算数据
   - 包含省份、CP、院校名称、日95结算值、结算时间等字段

2. **nfa_settlement_config** - 存储结算配置信息
   - 配置每日结算时间（默认凌晨2点）
   - 配置每周结算时间（默认周一凌晨2点）
   - 记录上次执行时间和启用状态

3. **nfa_settlement_task** - 记录结算任务执行情况
   - 记录任务类型、执行状态、开始/结束时间
   - 记录处理记录数和错误信息（如有）

## 后端开发计划

1. **模型层开发**
   - 创建 `SchoolSettlement` 模型，对应 `nfa_school_settlement` 表
   - 创建 `SettlementConfig` 模型，对应 `nfa_settlement_config` 表
   - 创建 `SettlementTask` 模型，对应 `nfa_settlement_task` 表
   - 创建相关的请求/响应结构体

2. **仓储层开发**
   - 实现结算数据的CRUD操作
   - 实现结算配置的CRUD操作
   - 实现结算任务的CRUD操作

3. **服务层开发**
   - 实现日95计算逻辑（按照从大到小排序，去掉前5%，取最大值）
   - 实现定时任务调度器，支持每日和每周定时执行结算任务
   - 实现结算任务执行和状态管理

4. **控制器层开发**
   - 实现结算配置管理API
   - 实现结算任务管理API
   - 实现结算数据查询API

5. **定时任务实现**
   - 实现每日凌晨2点计算前一天所有院校的日95值
   - 实现每周一凌晨2点计算上一周所有院校每天的日95值
   - 实现任务状态监控和错误处理机制

## 前端开发计划

1. **结算管理模块**
   - 创建独立的结算管理菜单，与现有功能分开
   - 实现结算配置页面，支持配置结算时间
   - 实现结算任务状态页面，展示当前和历史任务状态

2. **结算配置页面**
   - 展示当前结算配置（每日结算时间、每周结算日期和时间）
   - 提供配置修改功能
   - 提供结算任务启用/禁用功能

3. **结算任务状态页面**
   - 展示当前正在执行的结算任务状态
   - 提供历史结算任务查询功能
   - 展示任务执行详情（开始时间、结束时间、处理记录数、状态等）

4. **结算数据查询页面**
   - 提供按日期、省份、CP、院校等条件查询结算数据
   - 提供数据导出功能

## 测试计划

1. **单元测试**
   - 测试日95计算逻辑的正确性
   - 测试定时任务调度的准确性

2. **集成测试**
   - 测试结算数据的完整流程
   - 测试配置修改对结算任务的影响

3. **UI测试**
   - 测试前端页面的功能和交互

## 部署计划

1. **数据库迁移**
   - 执行SQL脚本创建新表
   - 初始化结算配置数据

2. **后端部署**
   - 部署新版本后端服务
   - 启动定时任务调度器

3. **前端部署**
   - 部署新版本前端应用

## 时间规划

1. 数据库设计与创建：1天
2. 后端模型层和仓储层开发：2天
3. 后端服务层和定时任务开发：3天
4. 后端控制器层和API开发：2天
5. 前端结算管理模块开发：3天
6. 测试与修复：2天
7. 部署与上线：1天

总计：约14天工作量

## 风险评估

1. 数据量大可能导致结算计算耗时较长，需要考虑性能优化
2. 定时任务需要保证高可靠性，避免任务丢失或重复执行
3. 结算数据的准确性至关重要，需要多重验证机制

## 后续计划

1. 实现结算数据的可视化展示
2. 添加结算数据异常检测机制
3. 实现结算数据与计费系统的对接

## 前端 UI/主题改造计划（参考 gin-vue-admin）

- 目标：
  - 统一布局与配色，构建“侧边栏 + 顶栏 + 面包屑 + 多页签 + 内容区”的专业管理台布局。
  - 支持主题切换（浅色/深色 + 主色），启用多页签（TagsView），保持与现有 RBAC 权限体系兼容。
  - 将现有全局标题样式规范与结算模块风格整合进主题变量体系，避免页面各自为政。
  - 渐进迁移业务页面，降低改造风险。

- 默认偏好（已确认）：
  - 多页签：启用
  - 侧边栏：默认展开
  - 组件尺寸：default；表格密度：normal

  - 里程碑与任务清单：
  - [x] 阶段 0：达成方案共识与风险识别（当前完成）
  - [x] 阶段 1：主题系统（Theme）基础设施
    - [x] 新建 `src/stores/theme.ts`（isDark、primary、size、density，localStorage 持久化）
    - [x] 新建 `src/styles/variables.css` 定义基础 CSS 变量（--color-primary/--bg-page/--text 等）
    - [x] 新建 `src/styles/dark.css` 暗色主题覆盖，使用 `data-theme="dark"` 切换
    - [x] `App.vue` 使用 `ElConfigProvider` 注入组件尺寸，响应 theme store
    - [x] `main.ts` 注入全局样式并设置 `document.documentElement.dataset.theme`
    - [ ] 整合/迁移 `src/assets/theme.css` 到变量体系（避免重复定义）
  - [x] 阶段 2：布局骨架（对齐 gin-vue-admin）
    - [x] 新建 `src/layouts/DefaultLayout.vue`（Sidebar + Navbar + Breadcrumb + TagsView + <router-view>）
    - [x] 新建 `src/components/Sidebar/Menu.vue`
    - [x] 新建 `src/components/Navbar/index.vue`
    - [x] 新建 `src/components/Breadcrumb/index.vue`
    - [x] 新建 `src/components/TagsView/index.vue`
    - [x] 路由改造为嵌套路由：`DefaultLayout` 作为根布局，`/login`、`/403` 等使用 `BlankLayout`
  - [x] 阶段 3：主题设置抽屉（SettingsDrawer）
    - [x] 新建 `src/components/Settings/SettingsDrawer.vue`（主色、暗色、侧边栏风格、尺寸、密度）
    - [x] 顶栏挂载入口按钮，实时生效并持久化
  - [x] 阶段 4：多页签（TagsView）
    - [x] 新建 `src/stores/tagsView.ts`（visitedViews、cachedViews）
    - [x] `router.afterEach` 收集标签，支持关闭/关闭其他/全部关闭/刷新
    - [x] `keep-alive` 与路由 `meta.cache` 协作控制缓存
  - [ ] 阶段 5：菜单与权限集成
    - [ ] Sidebar 从路由 `meta` 生成菜单树（title/icon/order/hideInMenu/alwaysShow）
    - [ ] 结合现有权限指令与路由守卫进行过滤与保护
  - [ ] 阶段 6：全局样式规范统一
    - [ ] 将 `.page-title`/`.card-title` 规范并入主题变量（字号/行高/颜色/间距）
    - [ ] 表单/表格密度、卡片风格统一，暗色与浅色各有一套变量
  - [ ] 阶段 7：页面渐进迁移
    - [ ] 迁移 Settlement* 页面到新布局与样式
    - [ ] 迁移 Rates*（Customer/Node/Final）页面
    - [ ] 迁移 System*（Users/Roles/Permissions）
    - [ ] 迁移 OperationLogs 页面
  - [ ] 阶段 8：QA 与文档
    - [ ] 深浅色对比度、键盘可达性、焦点可见性、响应式检查
    - [ ] 更新 README 与“前端开发规范/主题与布局使用说明”

- 约束与兼容：
  - 不改动后端 API 合约与权限模型；前端仅做 UI 与布局升级，确保联调稳定。
  - 遵循 SOLID/DRY/KISS/YAGNI 与 OWASP 最佳实践；主题配置仅存储在 localStorage，不存敏感信息。

- 验收标准：
  - 支持浅色/深色与主色切换，刷新后配置保持；组件尺寸/表格密度可切换。
  - 侧边菜单与按钮显示均受权限控制；无权限访问自动跳转 403。
  - 多页签可用且缓存策略生效，切换流畅；控制台无报错。
  - 页面统一卡片/标题/密度风格；暗色与浅色对比度达标，无明显样式错乱。
